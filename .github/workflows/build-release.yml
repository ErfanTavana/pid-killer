name: Build and Release EXE

on:
  push:
    tags:
      - "v*"       # هر tag که با v شروع شود، مثلا v1.0.0
  workflow_dispatch:  # اجرا به صورت دستی از تب Actions هم ممکن است

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller colorama psutil

      - name: Build EXE with PyInstaller
        run: |
          pyinstaller --onefile --uac-admin --icon=logo.ico --version-file=version_info.txt kill_pid_admin.py

      - name: Prepare artifact
        run: |
          mkdir output
          copy dist\kill_pid_admin.exe output\kill_pid_admin-${{ github.ref_name }}.exe

      - name: Generate release notes
        shell: pwsh
        run: |
          $notesPath = "release_notes.md"
          $tag = "${{ github.ref_name }}"

          function Write-Notes($lines) {
            $lines | Set-Content -Path $notesPath -Encoding UTF8
          }

          if (Test-Path "CHANGELOG.md") {
            $changelog = Get-Content "CHANGELOG.md"
            $pattern = "^##\s+.*$tag"
            $matches = $changelog | Select-String -Pattern $pattern

            if ($matches) {
              $startIndex = $matches[0].LineNumber - 1
              $nextHeading = ($changelog | Select-String -Pattern '^##\s+' -Context 0,0 | Where-Object { $_.LineNumber -gt $startIndex } | Select-Object -First 1)
              if ($nextHeading) {
                $endIndex = $nextHeading.LineNumber - 2
              } else {
                $endIndex = $changelog.Length - 1
              }
              Write-Notes $changelog[$startIndex..$endIndex]
              exit 0
            }

            Write-Notes @(
              "## Release $tag",
              "",
              "No matching section found in CHANGELOG.md. Full changelog:",
              "",
              $changelog
            )
            exit 0
          }

          $previousTag = git describe --tags --abbrev=0 "$tag^" 2>$null
          if ($LASTEXITCODE -eq 0 -and $previousTag) {
            $log = git log "$previousTag..$tag" --pretty=format:"* %s"
            if ($log) {
              Write-Notes @("## Changes since $previousTag", "", $log)
              exit 0
            }
          }

          $fallbackLog = git log -5 --pretty=format:"* %s"
          Write-Notes @("## Release $tag", "", "Recent changes:", "", $fallbackLog)

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Kill PID ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          body_path: release_notes.md
          files: output/kill_pid_admin-${{ github.ref_name }}.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
